version: "3.7"

services:
  database:
    image: docker.io/postgres:13.5-alpine
    restart: always
    environment:
      POSTGRES_PASSWORD: possupassu
    networks:
      - db_net
    volumes:
      - db-data:/var/lib/postgresql/data
      - db-run:/var/run/postgresql
      - ./my-app/db-config/initdb:/docker-entrypoint-initdb.d:ro

  migrations:
    image: docker.io/flyway/flyway
    restart: "no"
    command: "migrate"
    depends_on:
      - "database"
    networks:
      - db_net
    volumes:
      - ./my-app/db-config/flyway:/flyway/conf:ro
      - ./my-app/db-config/migrations:/flyway/sql:ro

  postgrest:
    image: docker.io/postgrest/postgrest
    restart: always
    depends_on:
      - "database"
      - "migrations"
    environment:
      PGRST_DB_URI: 'postgresql:///postgres?user=postgres'
      PGRST_DB_SCHEMA: api
      PGRST_DB_ANON_ROLE: api_anon
      PGRST_SECRET_IS_BASE64: 0
      PGRST_JWT_SECRET: JZT7z9E3dA4t25jB
    networks:
      - backend_net
    volumes:
      - db-run:/run/postgresql

  prod_image:
    container_name: capstone_sealdeal_prod_image
    depends_on:
      - postgrest
 {% if prod == 'true' %}
   image: {{dockerPath}}
 {% else %}
   build:
      context: .
      dockerfile: Dockerfile.prod
 {% endif %}

    networks:
      - backend_net
    ports:
      - "{{port}}:80"

networks:
  db_net:
  backend_net:

volumes:
  db-data:
  db-run:
