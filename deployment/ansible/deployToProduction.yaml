# deploy to production
---
- name: Initial Config Of Server
  hosts: azure
  become: true
  tasks:
    - name: create a directory named old
      file:
        path: ./old
        state: directory
        mode: 777

    - name: Create new docker-compose.yml using Jinja2
      template:
        src: docker-compose-new.j2
        dest: ./docker-compose.yml

    - name: Create new docker-compose.yml using Jinja2
      template:
        src: docker-compose-old.j2
        dest: ./old/docker-compose.yml

    - name: Log into private registry and force re-authorization
      docker_login:
        registry: "{{registery}}"
        username: "{{username}}"
        password: "{{password}}"

    - name: Tear down old Container
      docker_compose:
        project_src: ./old
        state: absent

    - name: Remove image
      docker_image:
        state: absent
        name: capstoneregistery.azurecr.io/capstone_sealdeal_prod_image
        tag: "{{previousCommit}}"

    - name: Pull IMG From Azure Registery
      docker_image:
        name: capstoneregistery.azurecr.io/capstone_sealdeal_prod_image
        tag: "{{commit}}"
        source: pull

    - name: Run project with docker-compose
      docker_compose:
        project_src: .
      register: output
    - ansible.builtin.debug:
        var: output
